---
title: "Supplementary material"
format:
  html: 
    code-fold: true
    html-math-method: katex
    number-sections: true
  docx:
    number-sections: true
  pdf: 
    geometry: margin=0.5cm
    template-partials: 
      - title.tex
    keep-tex: true
    number-sections: true
editor: source
link-citations: true
linestretch: 1.15       
mainfont: Times New Roman
fontsize: 12pt          
colorlinks: true
fig-height: 4
fig-width: 7.5
editor_options: 
  chunk_output_type: console
--- 

This section presents the supplementary material for this study. First, graphs are shown for the evaluation of the balance of IPW-ATT via entropy balance. Second, the complete estimated regression models are shown. Finally, the sensitivity analyses performed are shown.

```{r}
#| label: source2
#| echo: false
#| results: false
#| message: false
#| warning: false
#| include: false

library(here)
library(cobalt)
library(ggplot2)
library(cowplot)

source(here("processing/prod_analysis_multinom.R"))

table_format <- if (knitr::is_html_output()) {
   #conditional instructions for kable
   "html" #if html set "html" in format
 } else if (knitr::is_latex_output()) {
   "latex"#if latex set "latex" in format
 }

```


```{r}
#| label: fig-interact
#| fig-cap: "Balance SMD — Mobility treatment (ATT)"
#| fig-cap-location: bottom
#| echo: false
#| results: asis
#| warning: false
#| out-width: '90%'
#| fig-asp: 0.9


p1 <- cobalt::love.plot(W_lm_ll, stats = "m", abs = TRUE, threshold = .10,
                  var.order = "unadjusted", line = TRUE,
                  colors = c("grey70","black")) +
  ggtitle("Low-Middle")

p2 <- cobalt::love.plot(W_lh_ll, stats = "m", abs = TRUE, threshold = .10,
                  var.order = "unadjusted", line = TRUE,
                  colors = c("grey70","black")) +
  ggtitle("Low-High")

p3 <- cobalt::love.plot(W_mh_mm, stats = "m", abs = TRUE, threshold = .10,
                  var.order = "unadjusted", line = TRUE,
                  colors = c("grey70","black")) +
  ggtitle("Middle-High")

p4 <- cobalt::love.plot(W_ml_mm, stats = "m", abs = TRUE, threshold = .10,
                  var.order = "unadjusted", line = TRUE,
                  colors = c("grey70","black")) +
  ggtitle("Middle-Low")

p5 <- cobalt::love.plot(W_hm_hh, stats = "m", abs = TRUE, threshold = .10,
                  var.order = "unadjusted", line = TRUE,
                  colors = c("grey70","black")) +
  ggtitle("High-Middle")

p6 <- cobalt::love.plot(W_hl_hh, stats = "m", abs = TRUE, threshold = .10,
                  var.order = "unadjusted", line = TRUE,
                  colors = c("grey70","black")) +
  ggtitle("High-Low")

cowplot::plot_grid(p1, p2, p3, p4, p5, p6, label_size = 11, ncol = 2, nrow = 3)

```


```{r}
#| label: tbl-complete1
#| tbl-cap: "Effects of intergenerational occupational mobility on preferences for pension commodification, with covariates and wave fixed effects."
#| tbl-cap-location: top
#| results: asis
#| echo: false

ccoef <- list(
  "(Intercept)" = "Intercept",
  "t" = "Mobility treatment",
  edad = "Age (in years)",
  sexo = "Female (Ref. = Male)",
  nac = "Chilean nacionality (Ref. = Non-Chilean)",
  etnia = "Indigenous ethnicity (Ref. = Non-indigenous)",
  hogar = "Co-residence with both parents (Ref. = No co-residence)",
  edu0 = "Parental education",
  ola2018 = "Wave 2018",
  ola2023 = "Wave 2023"
  
)

texreg::texreg(list(mp_lm,
                       mp_lh,
                       mp_mh,
                       mp_ml,
                       mp_hm,
                       mp_hl),
                  custom.model.names = c(
                    "Low-Middle",
                    "Low-High",
                    "Middle-High",
                    "Middle-Low",
                    "High-Middle",
                    "High-Low"
                  ),   caption.above = NULL,
               caption = NULL,
               custom.coef.map = ccoef,
               digits = 2,
               groups = list("Wave (Ref.= 2016)" = 9:10),
               custom.note = "Note: Cells contain regression coefficients with confidence intervals in parentheses. %stars.",
               leading.zero = T,
               use.packages = F,
               booktabs = F,
               scalebox = 0.7,
               center = T,
               float.pos = "H!")
```



```{r}
#| label: tbl-complete2
#| tbl-cap: "Effects of intergenerational occupational mobility on preferences for pension commodification."
#| tbl-cap-location: top
#| results: asis
#| echo: false

# Low to middle

mp_lm_2 <- lm_robust(y ~ t,
                     weights = w,
                     se_type = "CR2",
                     clusters = idencuesta,
                     data = data_lm) 

# Low to high

mp_lh_2 <- lm_robust(y ~ t,
                     weights = w,
                     se_type = "CR2",
                     clusters = idencuesta,
                     data = data_lh) 

# Middle to high

mp_mh_2 <- lm_robust(y ~ t,
                     weights = w,
                     se_type = "CR2",
                     clusters = idencuesta,
                     data = data_mh) 


# Middle to low

mp_ml_2 <- lm_robust(y ~ t,
                     weights = w,
                     se_type = "CR2",
                     clusters = idencuesta,
                     data = data_ml) 

# High to middle

mp_hm_2 <- lm_robust(y ~ t,
                     weights = w,
                     se_type = "CR2",
                     clusters = idencuesta,
                     data = data_hm) 

# High to low

mp_hl_2 <- lm_robust(y ~ t,
                     weights = w,
                     se_type = "CR2",
                     clusters = idencuesta,
                     data = data_hl) 

ccoef <- list(
  "(Intercept)" = "Intercept",
  "t" = "Mobility treatment"
)

texreg::texreg(list(mp_lm_2,
                       mp_lh_2,
                       mp_mh_2,
                       mp_ml_2,
                       mp_hm_2,
                       mp_hl_2),
                  custom.model.names = c(
                    "Low-Middle",
                    "Low-High",
                    "Middle-High",
                    "Middle-Low",
                    "High-Middle",
                    "High-Low"
                  ),   caption.above = NULL,
               caption = NULL,
               custom.coef.map = ccoef,
               digits = 2,
               custom.note = "Note: Cells contain regression coefficients with confidence intervals in parentheses. %stars.",
               leading.zero = T,
               use.packages = F,
               booktabs = F,
               scalebox = 0.8,
               center = T,
               float.pos = "H!")
```


```{r}
#| label: tbl-complete3
#| tbl-cap: "Interactions effects between intergenerational occupational mobility and perceived meritocracy on preferences for pension commodification, with covariates and wave fixed effects."
#| tbl-cap-location: top
#| results: asis
#| echo: false


ccoef <- list(
  "(Intercept)" = "Intercept",
  "t" = "Mobility treatment",
  "mHigh" = "High meritocracy perception (Ref.= Low)",
  "t:mHigh" = "Mobility treatment x High meritocracy perception (Ref.= Low)"
)

texreg(list(mp_lm_i,
               mp_lh_i,
               mp_mh_i,
               mp_ml_i,
               mp_hm_i,
               mp_hl_i),
          custom.model.names = c(
            "Low-Middle",
            "Low-High",
            "Middle-High",
            "Middle-Low",
            "High-Middle",
            "High-Low"
          ),
          caption.above = NULL,
          caption = NULL,
          custom.coef.map = ccoef,
          digits = 2,
          custom.note = "Note: Cells contain regression coefficients with confidence intervals in parentheses. %stars.",
          leading.zero = T,
          use.packages = F,
          booktabs = F,
          scalebox = 0.7,
          center = T,float.pos = "H!",
          custom.gof.rows = list("Controls"=rep("Yes",6)))

```


```{r}
#| label: tbl-holm
#| tbl-cap: "Holm correction"
#| tbl-cap-location: top
#| results: asis
#| echo: false

data.frame(traj = c("Low→Middle","Low→High","Middle→Low","Middle→High","High→Middle","High→Low"),
           p_raw = p, p_holm = p_holm) %>% 
  mutate_at(.vars = c(2,3), .funs = ~ round(.,3)) %>% 
  mutate_at(.vars = c(2,3), .funs = ~ format(., nsmall=3)) %>% 
  mutate_all(~ as.character(.)) %>% 
  kableExtra::kable(format = table_format, 
                    col.names = c("Mobility treatment", "p value", "Holm"),
                    row.names = F,
                    booktabs = T, align = 'l',
                    caption = NULL) %>% 
  kableExtra::kable_styling(latex_options = "hold_position", 
                            position = "center") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F) %>% 
  kableExtra::row_spec(0, bold = T) %>% 
  kableExtra::add_footnote(label = c("Note: p values derived from Table 1"), notation = "none")

```


```{r}
#| label: tbl-evalues
#| tbl-cap: "E-values for ATT estimates by mobility trajectory (Ding & VanderWeele, 2016 approximation)"
#| tbl-cap-location: top
#| results: asis
#| echo: false


evalues_tbl %>% 
  mutate_at(.vars = c(2:12), .funs = ~ round(.,3)) %>% 
  mutate_at(.vars = c(2:11), .funs = ~ format(., nsmall=3)) %>% 
  mutate_all(~ as.character(.)) %>% 
  tidyr::unite("ci", ci_low:ci_high, sep = ";") %>% 
  kableExtra::kable(format = table_format, 
                    col.names = c("Mobility treatment", "Beta", "CI 95% [low-upper]", "sdY", "RR point", "RR point upper", "E point", "RR CI", "RR CI Upper", "E CI", "CI Crosses 0"),
                    row.names = F,
                    booktabs = T, 
                    align = 'l',
                    caption = NULL) %>% 
  kableExtra::kable_styling(latex_options = "hold_position", 
                            position = "center") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = T, font_size = 8) %>% 
  kableExtra::row_spec(0, bold = T)
```
