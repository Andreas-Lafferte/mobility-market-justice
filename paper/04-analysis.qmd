---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Results

```{r setup3, include=FALSE}
 knitr::opts_chunk$set(echo=FALSE, warning = FALSE,message = FALSE, cache = TRUE,out.width = '85%',fig.pos= "H"
                       # , fig.align = 'center'
                       )
 # knitr::opts_knit$set(base.url = "../") #relative path for .html output file
 # knitr::opts_knit$set(root.dir = "../") #relative path for chunks within .rmd files
 options(scipen=999)
 options(kableExtra.auto_format = FALSE)
 options(knitr.kable.NA = '')
 options(knitr.graphics.error = FALSE)
 Sys.setlocale("LC_ALL", "ES_ES.UTF-8")
 
 table_format = if (knitr::is_html_output()) {
   #conditional instructions for kable
   "html" #if html set "html" in format
 } else if (knitr::is_latex_output()) {
   "latex"#if latex set "latex" in format
 }
```


```{r}
#| label: libraries2
#| message: false
#| echo: false

if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               here,
               sjPlot,
               sjmisc,
               texreg,
               estimatr,
               conflicted,
               ggdist,
               summarytools,
               dagitty,
               ggdag)

conflicts_prefer(dplyr::filter)

options(scipen=999)
rm(list = ls())
```

```{r}
#| label: data2
#| message: false
#| echo: false

load(here("input/data/proc/data_v2.3.RData"))

```

## Descriptive statistics


Lorem ipsoThe specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustnessThe specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness


```{r}
#| label: fig-alluvial
#| fig-cap: "Change in preferences for pension commodification over time (2016, 2018, and 2023)."
#| fig-cap-location: bottom
#| echo: false
#| results: asis
db %>% 
  mutate(just_pension_f = factor(just_pension_f, levels = c(0,1), labels = c("Disagree", "Agree"))) %>%
  group_by(wave, just_pension_f) %>% 
  count() %>% 
  group_by(wave) %>% 
  mutate(porcentaje=n/sum(n)) %>% 
  ungroup() %>% 
  ggplot(aes(x = wave, y = porcentaje, group = just_pension_f)) +
  geom_col(aes(fill = just_pension_f)) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(
    values = c("#5b59d4", "#c8237d"),
    breaks = c("Agree","Disagree")
  )  +
  coord_flip() +
  geom_text(
    aes(label = paste0(round(porcentaje * 100, 1), "%")),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 3,
    fontface = "bold"
  ) +
  labs(y = NULL,
       x = NULL,
       fill = NULL,
       caption = "Source: own elaboration with data from ELSOC 2016-2023 (N obs = 3,435)") +
  theme_ggdist() +
  theme(legend.position = "top") 
```

The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness

```{r}
#| label: fig-mean
#| fig-cap: "Percentage agreement on preferences for pension commodification according to mobility trajectory and time (2016, 2018, and 2023)."
#| out-width: '90%'
#| fig-cap-location: bottom
#| echo: false
#| results: asis

pdat <- db %>% 
  select(wave, estrato_orig, estrato_ocupa, just_pension_f) %>% 
  drop_na() %>% 
  mutate(
    mobility = paste(estrato_orig, estrato_ocupa, sep = "-"),
    facet = case_when(
      mobility %in% c("High-Middle","High-Low","Middle-Low") ~ "Downward",
      estrato_orig == estrato_ocupa ~ "Inmobile",
      mobility %in% c("Middle-High","Low-Middle","Low-High") ~ "Upward"
    )
  ) %>% 
  group_by(wave, mobility, facet) %>% 
  summarise(y = mean(just_pension_f), .groups = "drop") %>% 
  group_by(mobility, facet) %>% 
  mutate(gm = mean(y)) %>% 
  ungroup()

# datos SOLO para el punto (uno por categoría)
pdat_gm <- pdat %>% distinct(mobility, facet, gm)

ggplot(pdat, aes(x = mobility, y = y, group = wave)) +
  geom_col(aes(fill = wave), position = "dodge", alpha = 0.9) +
  # Punto "X" (pch 4) con su propia leyenda (shape)
  geom_point(
    data = pdat_gm,
    aes(x = mobility, y = gm, shape = "All waves"),
    inherit.aes = FALSE,
    size = 3, stroke = 1, color = "black"
  ) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) + 
  scale_fill_manual(
    values = c("2016" = "#5b59d4", "2018" = "#b3b3b3ff", "2023" = "#c8237d"),
    name   = "Wave"
  ) +
  scale_shape_manual(                     # <-- leyenda separada para el shape
    name = NULL,                          # o "Marker" si quieres título
    values = c("All waves" = 4)          # 4 = "X"
  ) +
  guides(
    fill  = guide_legend(order = 1),
    shape = guide_legend(order = 2, override.aes = list(color = "black"))
  ) +
  facet_wrap(~ facet, scales = "free_x") +
  labs(
    y = "% of Agreement",
    x = NULL,
    caption = "Source: own elaboration with data from ELSOC 2016–2023 (N obs = 3,435)"
  ) +
  theme_ggdist() +
  theme(legend.position = "top")

```


## Models

The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness

```{r}
#| label: models
#| echo: false
#| results: false

### Pensiones 

### Low to middle

data_lm <- datos1 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = moblm, 
         w = w_low_lm_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_lm <-
  lm_robust(y ~ t + edad + sexo + nac + etnia + hogar + edu0 + ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_lm) 

### Low to high

data_lh <- datos1 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = moblh, 
         w = w_low_lh_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_lh <- 
  lm_robust(y ~ t + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_lh) 

### middle to high

data_mh <- datos2 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobmh, 
         w = w_mid_mh_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_mh <-  
  lm_robust(y ~ t + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_mh) 

### middle to low

data_ml <- datos2 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobml, 
         w = w_mid_ml_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_ml <- 
  lm_robust(y ~ t + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_ml) 


### High to middle

data_hm <- datos3 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobhm, 
         w = w_hig_hm_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_hm <- 
  lm_robust(y ~ t + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_hm) 


### High to low

data_hl <- datos3 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobhl, 
         w = w_hig_hl_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_hl <- 
  lm_robust(y ~ t + edad + sexo + nac + etnia + hogar + edu0 + ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_hl) 

```



```{r}
#| label: fig-reg
#| fig-cap: "Effects of intergenerational occupational mobility on preferences for pension commodification. Coefficient plot of origin-specific ATT estimates comparing mobility versus immobility. Estimates from pooled WLS with doubly robust adjustment, wave fixed effects, and standard errors clustered by individual; bars show 95% confidence intervals."
#| out-width: '90%'
#| fig-cap-location: bottom
#| echo: false
#| results: asis

conflicts_prefer(dplyr::filter)

df_pension <- bind_rows(
  tidy(mp_lm, conf.int = TRUE) %>%
    dplyr::filter(term == "t") %>%
    dplyr::mutate(term = paste0("Low-Middle\n", "(N obs. = ", mp_hl$nobs, ";", "\nN clusters = ", mp_hl$nclusters, ")")
) 
  ,
  tidy(mp_lh, conf.int = TRUE) %>%
    dplyr::filter(term == "t") %>%
  dplyr::mutate(term = paste0("Low-High\n", "(N obs. = ", mp_lh$nobs, ";", "\nN clusters = ", mp_lh$nclusters, ")"))
  ,
tidy(mp_mh, conf.int = TRUE) %>%
    dplyr::filter(term == "t") %>%
    dplyr::mutate(term = paste0("Middle-High\n", "(N obs. = ", mp_mh$nobs, ";", "\nN clusters = ", mp_mh$nclusters, ")"))
,
  tidy(mp_ml, conf.int = TRUE) %>%
    dplyr::filter(term == "t") %>%
  dplyr::mutate(term = paste0("Middle-Low\n", "(N obs. = ", mp_ml$nobs, ";", "\nN clusters = ", mp_ml$nclusters, ")"))
,
  tidy(mp_hm, conf.int = TRUE) %>%
    dplyr::filter(term == "t") %>%
  dplyr::mutate(term = paste0("High-Middle\n", "(N obs. = ", mp_hm$nobs, ";", "\nN clusters = ", mp_hm$nclusters, ")"))
,
  tidy(mp_hl, conf.int = TRUE) %>%
    dplyr::filter(term == "t") %>%
  dplyr::mutate(term = paste0("High-Low\n", "(N obs. = ", mp_hl$nobs, ";", "\nN clusters = ", mp_hl$nclusters, ")"))
) 

df_pension_lab <- df_pension %>%
  dplyr::mutate(
    sig     = ifelse(conf.low * conf.high > 0, "*", ""),  # IC no cruza 0
    est_lab = sprintf("%.2f%s", estimate, sig),
    low_lab = sprintf("%.2f", conf.low),
    high_lab= sprintf("%.2f", conf.high)
  )

df_pension_lab <- df_pension_lab %>%
  dplyr::mutate(
    term = factor(
      term,
      levels = term
      )
  )

ggplot(df_pension_lab, aes(x = estimate, y = term)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred", size = 0.5, alpha = 1) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0, size = 0.7) +
  geom_point(size = 2.5) +
  scale_x_continuous(limits = c(-0.5, 0.5), breaks = seq(-0.5, 0.5, 0.25)) +
  #geom_text(aes(label = est_lab), hjust = -0.05, size = 4, vjust = -0.5) +
  labs(x = "Estimate", y = NULL) +
  theme_ggdist() 
```


The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustnessThe specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness

## Effect heterogeneity


The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness
```{r}
#| echo: false
#| results: false

# 3.4 Interacciones -------------------------------------------------------

# -----------
# Meritocracy 
# -----------

### Interacciones

### Low to middle

data_lm_i <- datos1 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = moblm, 
         w = w_low_lm_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f,
         m = merit_i) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

data_lm_i %>% 
  arrange(idencuesta)

mp_lm_i <-
  lm_robust(y ~ t*m + edad + sexo + nac + etnia + hogar + edu0 + ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_lm_i) 

mp_lm_i %>%  
  screenreg()

### Low to high

data_lh_i <- datos1 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = moblh, 
         w = w_low_lh_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f,
         m = merit_i) %>%  
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_lh_i <- 
  lm_robust(y ~ t*m + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_lh_i) 

mp_lh_i %>% 
  screenreg()


### middle to high

data_mh_i <- datos2 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobmh, 
         w = w_mid_mh_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f,
         m = merit_i) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_mh_i <-  
  lm_robust(y ~ t*m + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_mh_i) 

mp_mh_i %>% 
  screenreg()

### middle to low

data_ml_i <- datos2 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobml, 
         w = w_mid_ml_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f,
         m = merit_i) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_ml_i <- 
  lm_robust(y ~ t*m + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_ml_i) 

mp_ml_i %>% 
  screenreg()


### High to middle

data_hm_i <- datos3 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobhm, 
         w = w_hig_hm_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f,
         m = merit_i) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_hm_i <- 
  lm_robust(y ~ t*m + edad + sexo + nac + etnia + hogar + edu0+ ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_hm_i) 

mp_hm_i %>% 
  screenreg()

### High to low

data_hl_i <- datos3 %>% 
  select(idencuesta, 
         ola, 
         y = just_pension_f, 
         t = mobhl, 
         w = w_hig_hl_t, 
         edad = m0_edad_f, 
         sexo = sexo_f, 
         nac = nacionalidad_f,
         etnia = etnia_f,
         hogar = hogar_bip_f, 
         edu0 = educ_orig_f,
         m = merit_i) %>% 
  filter(!is.na(t), !is.na(w)) %>% 
  mutate(ola = factor(ola, levels = c("1", "2", "3"),
                      labels = c("2016", "2018", "2023")))

mp_hl_i <- 
  lm_robust(y ~ t*m + edad + sexo + nac + etnia + hogar + edu0 + ola,
            weights = w,
            se_type = "CR2",
            clusters = idencuesta,
            data = data_hl_i) 

mp_hl_i %>% 
  screenreg()
```

The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness

```{r}
#| label: fig-interact
#| fig-cap: "Effects of intergenerational occupational mobility on preferences for pension commodification, by meritocratic perception. Coefficient plot of origin-specific ATT estimates comparing mobility versus immobility, estimated from interaction models (T × Merit). Points show simple slopes of the mobility effect at low merit and high merit; bars are 95% confidence intervals. Estimates from pooled WLS with doubly robust adjustment, wave fixed effects, and standard errors clustered by individual."
#| out-width: '90%'
#| fig-cap-location: bottom
#| echo: false
#| results: asis

df_pension_i <-  bind_rows(
  tidy(mp_lm_i, conf.int = TRUE) %>%
    filter(term %in% c("t:mHigh", "t")) %>%
    mutate(name = paste0("Low-Middle\n", "(N obs. = ", mp_hl_i$nobs, ";", "\nN clusters = ", mp_hl_i$nclusters, ")")
    ) 
  ,
  tidy(mp_lh_i, conf.int = TRUE) %>%
    filter(term %in% c("t:mHigh", "t")) %>%
    mutate(name = paste0("Low-High\n", "(N obs. = ", mp_lh_i$nobs, ";", "\nN clusters = ", mp_lh_i$nclusters, ")"))
  ,
  tidy(mp_mh_i, conf.int = TRUE) %>%
    filter(term %in% c("t:mHigh", "t")) %>%
    mutate(name = paste0("Middle-High\n", "(N obs. = ", mp_mh_i$nobs, ";", "\nN clusters = ", mp_mh_i$nclusters, ")"))
  ,
  tidy(mp_ml_i, conf.int = TRUE) %>%
    filter(term %in% c("t:mHigh", "t")) %>%
    mutate(name = paste0("Middle-Low\n", "(N obs. = ", mp_ml_i$nobs, ";", "\nN clusters = ", mp_ml_i$nclusters, ")"))
  ,
  tidy(mp_hm_i, conf.int = TRUE) %>%
    filter(term %in% c("t:mHigh", "t")) %>%
    mutate(name = paste0("High-Middle\n", "(N obs. = ", mp_hm_i$nobs, ";", "\nN clusters = ", mp_hm_i$nclusters, ")"))
  ,
  tidy(mp_hl_i, conf.int = TRUE) %>%
    filter(term %in% c("t:mHigh", "t")) %>%
    mutate(name = paste0("High-Low\n", "(N obs. = ", mp_hl_i$nobs, ";", "\nN clusters = ", mp_hl_i$nclusters, ")"))
) 

df_pension_lab_i <- df_pension_i %>%
  mutate(
    sig     = ifelse(conf.low * conf.high > 0, "*", ""),  # IC no cruza 0
    est_lab = sprintf("%.2f%s", estimate, sig),
    low_lab = sprintf("%.2f", conf.low),
    high_lab= sprintf("%.2f", conf.high)
  )

df_pension_lab_i <- df_pension_lab_i %>%
  mutate(
    name = factor(
      name,
      levels = unique(name)
    ),
    term = if_else(term == "t", "Low Meritocracy", "High Meritocracy"),
    term = factor(term, levels = c("High Meritocracy", "Low Meritocracy"))
  )


ggplot(df_pension_lab_i, aes(x = estimate, y = name)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred", size = 0.5, alpha = 1) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0, size = 0.7) +
  geom_point(size = 2.5) +
  scale_x_continuous(limits = c(-0.5, 0.5), breaks = seq(-0.5, 0.5, 0.25)) +
  facet_wrap(~term) + 
  #geom_text(aes(label = est_lab), hjust = -0.05, size = 4, vjust = -0.5) +
  labs(x = "Estimate", y = NULL) +
  theme_ggdist()

```



```{r}
#| label: tbl-inttime
#| tbl-cap: "Effects of intergenerational occupational mobility on preferences for pension commodification, by survey wave"
#| tbl-cap-location: top
#| results: asis
#| echo: false

# -----------
# Time 
# -----------

# Low to middle

mp_lm_t <- lm_robust(y ~ t*ola + edad + sexo + nac + etnia + hogar + edu0,
          weights = w,
          se_type = "CR2",
          clusters = idencuesta,
          data = data_lm) 

# Low to high

mp_lh_t <- lm_robust(y ~ t*ola+ edad + sexo + nac + etnia + hogar + edu0,
          weights = w,
          se_type = "CR2",
          clusters = idencuesta,
          data = data_lh) 

# Middle to high

mp_mh_t <- lm_robust(y ~ t*ola + edad + sexo + nac + etnia + hogar + edu0,
          weights = w,
          se_type = "CR2",
          clusters = idencuesta,
          data = data_mh) 


# Middle to low

mp_ml_t <- lm_robust(y ~ t*ola + edad + sexo + nac + etnia + hogar + edu0,
          weights = w,
          se_type = "CR2",
          clusters = idencuesta,
          data = data_ml) 

# High to middle

# tiempo: descender se vuelve un efecto positivo en la ultima ola (con mi plata no)
mp_hm_t <- lm_robust(y ~ t*ola + edad + sexo + nac + etnia + hogar + edu0,
          weights = w,
          se_type = "CR2",
          clusters = idencuesta,
          data = data_hm) 

# High to low

mp_hl_t <- lm_robust(y ~ t*ola + edad + sexo + nac + etnia + hogar + edu0,
          weights = w,
          se_type = "CR2",
          clusters = idencuesta,
          data = data_hl) 


ccoef <- list(
  "(Intercept)" = "Intercept",
  "t" = "Mobility treatment",
  "ola2018" = "Wave 2018",
  "ola2023" = "Wave 2023",
  "t:ola2018" = "Mobility treatment x Wave 2018",
  "t:ola2023" = "Mobility treatment x Wave 2023"
  )

texreg::texreg(list(mp_lm_t,
               mp_lh_t,
               mp_mh_t,               
               mp_ml_t,
               mp_hm_t,
               mp_hl_t),
          custom.model.names = c(
            "Low-Middle",
            "Low-High",
            "Middle-High",            
            "Middle-Low",
            "High-Middle",
            "High-Low"
          ),   caption.above = NULL,
               caption = NULL,
               custom.coef.map = ccoef,
               digits = 2,
               groups = list("Wave (Ref.= 2016)" = 3:4, "Mobility treatment x Wave (Ref.= 2016)" = 5:6),
               custom.note = "Note: Cells contain regression coefficients with confidence intervals in parentheses. %stars.",
               leading.zero = T,
               use.packages = F,
               booktabs = F,
               scalebox = 0.80,
               center = T,float.pos = "H!",
               custom.gof.rows = list("Controls"=rep("Yes",6)))
               
```



## Sensitivity analysis

The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds ifeither the weighting model or the outcome model is correctly specified, while also improving efficiency (Wooldridge, 2009).I report both IPW-only and doubly robust specifications to document robustness