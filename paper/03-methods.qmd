---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup2, include=FALSE}
 knitr::opts_chunk$set(echo=FALSE, warning = FALSE,message = FALSE, cache = TRUE,out.width = '85%',fig.pos= "H"
                       # , fig.align = 'center'
                       )
 # knitr::opts_knit$set(base.url = "../") #relative path for .html output file
 # knitr::opts_knit$set(root.dir = "../") #relative path for chunks within .rmd files
 options(scipen=999)
 options(kableExtra.auto_format = FALSE)
 options(knitr.kable.NA = '')
 options(knitr.graphics.error = FALSE)
 Sys.setlocale("LC_ALL", "ES_ES.UTF-8")
 
 table_format = if (knitr::is_html_output()) {
   #conditional instructions for kable
   "html" #if html set "html" in format
 } else if (knitr::is_latex_output()) {
   "latex"#if latex set "latex" in format
 }
```

```{r}
#| label: data1
#| echo: false
#| results: false
#| message: false
#| warning: false
library(here)
library(janitor)
library(dagitty)
library(ggdag)
library(tidyverse)

load(here("input/data/proc/data_v2.3.RData"))
```

# Method

Social mobility effects—understood as impacts on an outcome arising from movements between an origin state and a destination state (e.g., social class)—have long been a focus of sociological research [@eyles_social_2022; @langsaether_explaining_2022]. Yet, as Breen and Ermisch [-@breen_effects_2024, p.467] emphasize, most of the mobility hypotheses are, at their core, individual-level counterfactual comparisons between the observed outcome under a mobility trajectory and the outcome the same person would have shown if they had remained in their origin class (or moved to an alternative destination). Standard specifications (e.g., SAM, DRM, and mobility-contrast models) struggle to retrieve these inherently counterfactual quantities due to identification constraints and their reliance on between-group contrasts constructed from additive terms and interactions, thereby yielding primarily associational evidence [@breen_effects_2024; @song_there_2025]. Following the causal framework of Breen and Ermisch [-@breen_effects_2024], I conceive of the destination class as a treatment, conditioning on the origin class and estimating the heterogeneous effects of the destination with observational data under explicit identification assumptions. To align design and target, I follow the MIDA template [@blair_research_2023]: set out the causal model and assumptions (M), define the inquiry and estimand (I), describe the data and variables (D), and detail the answer strategy (A) used to identify the causal effect of intergenerational occupational mobility on preferences for the commodification of pensions.

## A Causal Model for Mobility Effects

Breen and Ermisch [-@breen_effects_2024], building on a critical reassessment of the inferential limits of standard mobility models, propose a causal framework that reconceptualizes the “mobility effect” as the treatment effect of reaching a destination class, with impacts heterogeneous by class of origin. The core claim is that typical mobility hypotheses are fundamentally within-person counterfactual comparisons rather than between-person contrasts. Defining mobility as $M = D - O$; a change from origin $(O)$ to destination $(D)$, rather than an additive or interactive combination, places the focus squarely on the Neyman–Rubin problem: for any individual, we observe the result in the social position they currently occupy, but not in the situation of other alternative destinations or immobility.

Exploiting the temporal ordering of origin, destination and outcome, Breen and Ermisch [-@breen_effects_2024] frame mobility as a treatment process that motivates the causal question: "how would the outcome among people from origin *j* who entered destination *k* have been different if those people had, counterfactually, entered destination *k’* instead?" (p.472). The corresponding estimand is the conditional causal effect of destination given origin. It is of particular interest when *k' = j*, i.e., immobility. This estimand compares movers’ observed outcomes with the hypothetical outcomes those same individuals would have exhibited had they remained in their origin class. This formulation provides a coherent potential-outcomes basis for studying how social mobility shape individual preferences and attitudes.

Following Breen and Ermisch [-@breen_effects_2024], the identification of causal mobility effects from observational data requires the following assumptions:

**Positivity**: For all $(j,c)$ in the support of $(O,C)$ and for each relevant destination $(k)$, the probability of receiving $D=k$ is strictly between 0 and 1; substantively, each type $(O,C)$ has a nonzero probability of entering each comparison destination.

$$
 0<P(D=k\mid O=j, C=c)<1
$$ {#eq-posi}


**Stable Unit Treatment Value Assumption (SUTVA)**: each unit's potential outcomes $Y_i(D)$ does not depend on the mechanism used to assign treatments (destinations) and by the treatments assigned to other units (also called no interference), assuming a single, well-defined version of each treatment (consistency).

$$
Y_i(D_i) = Y_i\big(D_i, D_{-i}\big)\quad \forall, D_{-i}
$$ {#eq-sutva}

**Conditional Independence**: Also known as conditional unconfoundedness or exchangeability, this assumption emphasizes that, conditional on origin $O$ and pre-treatment covariates $C$ (e.g., parental education, ethnicity, cohort, early-life factors), assignment to $D$ is as good as random. This underlies IPW and regression adjustment, which seek exchangeability between mobile (treated) and immobile individuals (controls).

$$
Y(D)\ \perp\kern-5pt \perp D\ \mid\ (O,C)
$$ {#eq-indep}

Establishing the causal relationship between objective social mobility and subjective outcomes, such as preferences, poses several challenges for causal inference. Below, I use directed acyclic graphs (DAGs) to illustrate some of these challenges and evaluate possible strategies for identifying the effects of social mobility. @fig-dag depicts the causal model guiding identification. In this model, a respondent’s preference $Y$ is directly affected by her class destination $D$, and indirectly influenced by a set of pre-treatment attributes $C$ rooted in childhood—family resources, household composition, parental education, and other ascriptive characteristics. Class origin $O$ is itself shaped by these background factors $C$ and, in turn, affects destination $D$. I allow for unobserved determinants $U$ that influence background factors $C$, but I assume that any such unobserved variation operates only through $C$. Thus, there are no direct paths $U \rightarrow D$ or $U \rightarrow Y$ beyond those mediated by $C$.

Under this structure, conditioning on $(O, C)$ blocks all relevant backdoor paths from $D$ to $Y$—notably $D \leftarrow O \leftarrow C \rightarrow Y$. This renders $(O, C)$ a minimal sufficient adjustment set for identifying the causal effect of mobility on preferences, in line with the framework proposed by @breen_effects_2024. Identification therefore relies on the assumption that background factors $C$ adequately summarize pre-treatment characteristics that jointly shape both mobility and attitudes. 

```{r}
#| label: fig-dag
#| out-width: '85%'
#| fig-cap: "Causal graph of the effect of intergenerational social mobility on preferences for commodification. Y = preferences for pension commodification, D = an individual’s class of destination, O = an individual’s class of origin, C = different attributes determined in childhood or earlier that affects an individual’s class of origin and destination. Finally, U = unobserved factors influencing origin attributes."
#| fig-cap-location: bottom
#| echo: false
#| warning: false
#| message: false


dag_mjp <- dagify(
  Y ~ D + C,
  D ~ O + C,
  O ~ C,
  C ~ U,
  coords = time_ordered_coords(
    list(
      "U",
      c("C", "O"),
      "D",
      "Y"
    )
  ),
  exposure = "D",
  outcome = "Y",
  labels = c(
    Y = "Y",
    D = "D",
    O = "O",
    C = "C",
    U = "U"
  )
)

curvatures <- rep(0, 8)
curvatures[3] <- -.25

dag_mjp |>
  tidy_dagitty() |>
  ggplot(aes(x, y, xend = xend, yend = yend)) +
  geom_dag_point(shape = 21, fill = "black", size = 14, stroke = 0.8) +
  geom_dag_edges_arc(curvature = curvatures) +
  geom_dag_text(aes(label = label), color = "white", fontface = "bold", size = 4) +
  theme_dag()

```


Why are the assumptions plausible here? Conditional independence is targeted by controlling for a plausible sufficient adjustment set $(O,C)$ and by using inverse probability weights obtained via entropy balancing [@hainmueller_entropy_2012], which enforce covariate balance within each origin stratum and mitigate selection on observables. Positivity is assessed by inspecting the distribution of the entropy-balancing weights and trimming observations with extreme weights, thus restricting inference to regions of common support. SUTVA holds by treating the destination class as a single exposure measured before $(Y)$ and assuming no interference. Together, the DAG and assumptions define conditions for identifying the causal effect of intergenerational social mobility on preferences for commodification.

## Inquiry and estimand

The causal inquiry guiding this study asks: How does intergenerational social mobility affect individuals’ preferences for the commodification of pensions in Chile? Substantively, I am interested in the effect of mobility relative to immobility within a given class of origin.

Following the potential outcomes framework proposed by Breen and Ermisch [-@breen_effects_2024, p.473], the estimand of interest is an average treatment effect on the treated (ATT) defined within each origin class. I focus on the specific case in which the counterfactual destination corresponds to class immobility $(k' = j)$. In other words, I ask how the outcome among people from origin *j* who entered destination *k* would have bee different if those people had, counterfactually, remained in origin *j* instead (inmobility). 

Formally,  for individuals with origin $(O=j)$ who attain destination $(D=k)$, the estimand is:

$$ 
ATT_{j,k,j} = E\big[Y(D = k) \mid O = j, D = k \big] - E\big[Y(D = j) \mid O = j, D = k \big]
$${#eq-att}

which represents the mean causal effect of moving from origin class $(j)$ to destination class $(k)$, compared to the counterfactual outcome those same individuals would have exhibited had they instead remained in $(j)$. Thus, this ATT captures the counterfactual contrast within origin that lies at the heart of mobility effects: how preferences for market-based pensions would differ if, for the same upwardly or downwardly mobile individuals, their observed destination class were replaced by immobility in their origin class.

## Data and variables

### Data

This study draws on data from the Chilean Longitudinal Social Survey (ELSOC) of the Center for Social Conflict and Cohesion Studies (COES). This survey is a nationally representative panel study of the urban adult population in Chile, conducted annually between 2016 and 2023. Designed to examine individuals’ attitudes, emotions, and behaviors regarding social conflict and cohesion, ELSOC employs a probabilistic, stratified, clustered, and multistage sampling design covering both major urban centers and smaller cities. The sampling frame was proportionally stratified into six categories of urban population size (e.g., large and small cities), followed by a random selection of households within 1,067 city blocks. The target population includes men and women aged 18 to 75 who are habitual residents of private dwellings.

Because respondent occupation[^1] is not measured in every wave, I restrict the analysis to the 2016, 2018, and 2023 waves. After listwise deletion and restricting to key variables (respondent occupation and the outcome measure), the final analytic sample comprises *N* = 3,435 observations nested within *N* = 1,787 individuals (2016: 914; 2018: 1,377; 2023: 1,144). Consistent with the study design, estimation proceeds within trajectory-specific subsamples (e.g., low→low; low→middle), retaining movers and matched non-movers from the same origin class. Then, I apply weights to construct the corresponding counterfactual control sample for each trajectory. Following Breen and Ermisch [-@breen_effects_2024], I use the three waves in the estimations that follow, allowing for correlation between the observations for each individual in calculating the standard errors (i.e. clustering on the personal identifier).

[^1]: Parental occupation was collected only in 2023 as open-text labels. I coded these texts to the ISCO-08 two-digit scheme using the National Institute of Statistics of Chile’s automated coding API and retained cases with high-confidence matches (>95%). Treating parental occupation as a time-invariant origin attribute, I carried these codes back to 2016 and 2018. 

### Outcome variable

The outcome variable measures preferences regarding the commodification of pensions, operationalized with a single item addressing how strongly individuals justify conditioning access to old-age pension benefits based on individual income. Respondents were asked: “Is it fair in Chile that people with higher incomes have better pensions than people with lower incomes?” and answered on a five-point Likert scale ranging from 1 (“strongly disagree”) to 5 (“strongly agree”). For estimation and interpretability, I construct a binary indicator in which values 4–5 indicate agreement with market-based access to old-age pensions (coded 1), while values 1–3 indicate non-agreement (coded 0). Substantively, the dependent variable is meant to capture *endorsement* of pension commodification: only responses in the upper tail of the scale represent an active, explicit justification of market-based differentiation, whereas neutrality corresponds to an absence of such endorsement and is therefore treated as closer to non-support than to support.[^2] This binary coding thus yields a clear contrast between respondents who *support* market-based differentiation in pensions and those who do not. I use this item for two main reasons: first, to enable comparisons with existing work on market-based justice in social policy [@lindh_public_2015; @otero_power_2024; @castillo_perceptions_2025]; and second, because it taps two core dimensions of market-based welfare distribution—(i) the centrality of economic resources as a criterion for allocating outcomes and (ii) the framing of pensions as tradable commodities that can be bought and sold according to ability to pay [@lindh_public_2015].   

[^2]: A potential concern is that the neutral category may reflect genuine ambivalence rather than disagreement. To address this, I conduct robustness checks using alternative codings: (i) excluding neutral respondents from the analysis; (ii) combining the neutral and agreement categories (3–5 vs. 1–2); and (iii) estimating models with the original 5-point scale using linear specifications. The main mobility effects reported below are substantively unchanged across these specifications (see [Supplementary Material](#anexo)).

### Treatment

#### Intergenerational occupational mobility 

I treat intergenerational occupational mobility as an exposure indicating whether respondents occupy a different occupational status than their fathers, closely following Breen and Ermisch’s [-@breen_effects_2024] causal framework. Occupational assignment proceeds in two steps. First, I derive occupational status for both origin (father) and destination (respondent) from two-digit ISCO-08 codes using the International Socio-Economic Index of Occupational Status (ISEI). Second, I group these ISEI scores into terciles (low, middle, high), yielding a three-category schema for both origin and destination strata (see @tbl-matrix). Substantively, I use ISEI because occupational status is a core indicator of stratification and a reliable mobility measure: it locates jobs on a hierarchical continuum defined by incumbents’ typical education level and earnings [@hauser_intergenerational_2010; @salgado_uplifting_2025], and thus approximates long-run socio-economic position more closely than volatile, single-year income, which is also prone to recall and reporting error for both parental and own resources [@barone_rise_2022]. This occupational focus is consistent with a long tradition that interprets the occupational structure as the backbone of the stratification system and a key determinant of life chances [@wrightUnderstandingClass2015]. Moreover, ISEI was explicitly designed to harmonize occupational stratification across class schemes and SES measures [@ganzeboom_internationally_1996], supporting cross-study comparability. In short, using ISEI aligns the measurement of origin and destination on a common vertical status continuum that is theoretically meaningful for social mobility research and empirically feasible given the available information of ELSOC’s data.


```{r}
#| label: tbl-matrix
#| tbl-cap: "Occupational mobility by occupational groups."
#| tbl-cap-location: top
#| results: asis
#| echo: false

db %>%
  tabyl(estrato_orig, estrato_ocupa) %>%
  adorn_totals(where = c("row", "col")) %>%     # agrega totales
  adorn_percentages("row") %>%                  # porcentajes por fila
  adorn_pct_formatting(digits = 1) %>%          # formato %
  adorn_ns() %>% 
  as_tibble() %>% 
  mutate(Offspring = NA) %>% 
  select(estrato_orig, Offspring, everything()) %>% 
  kableExtra::kable(format = table_format, 
                    booktabs= T,
                    align = 'c', 
                    col.names = c("Father↓", "Offspring→", "Low", "Middle", "High", "Total"),
                    caption = NULL) %>%
  kableExtra::kable_styling(latex_options = "hold_position", 
                            bootstrap_options = "striped",
                            full_width = F) 


```


#### Pre-treatment control variables for selection into treatment

Within each origin stratum ($O = j$), I estimate average treatment effects on the treated (ATT) by comparing movers to otherwise similar non-movers from the same origin. To reduce bias from non-random selection into mobility based on observed characteristics, I preprocess the data using entropy balancing, reweighting only the control group (the immobile) so that the distribution of pre-treatment origin covariates $C$ among non-movers matches that of movers on selected moments. Entropy balancing implements a maximum-entropy reweighting scheme that chooses unit weights for non-movers to satisfy a set of balance constraints (e.g., equality of means and, where relevant, higher moments), while keeping the new weights as close as possible to the original weights [@hainmueller_entropy_2012]. Substantively, this procedure addresses selection on observables: it reweights immobile respondents so that, within each origin class, they resemble mobile respondents in their observed background characteristics, making any remaining differences in the outcome more plausibly attributable to mobility rather than to pre-existing measured advantages.


The selection of the adjustment set $C$ follows two principles. First, it mirrors the logic in Breen and Ermisch [-@breen_effects_2024], who condition on attributes determined in childhood or earlier (e.g., parental resources, household structure, ascriptive traits). Second, it is constrained to origin-side characteristics available in ELSOC. Guided by theory and Chilean evidence on the determinants of relative mobility [mainly @brunori_inequality_2025; @salgado_uplifting_2025; @espinoza_movilidad_2014; @torche_unequal_2005], I include six covariates covering family resources, household composition, and ascriptive status: (a) parental education (highest of father/mother), in 10 ordinal categories from no schooling to postgraduate studies; (b) co-residence with both parents at age 15 (0 = no, 1 = yes); (c) nationality (0 = non-Chilean, 1 = Chilean); (d) age in years; (e) sex (0 = male, 1 = female); and (f) indigenous ethnicity (0 = no, 1 = yes). This set of covariates is fixed prior to the destination class and constitutes the maximum set on the origin side in ELSOC, thus allowing for the plausible capture of both family and contextual influences that may affect career trajectories, making the conditional independence hypothesis more credible within each $O = j$. Descriptive statistics for all variables are presented in Supplementary Material Table A1.


After achieving balance, I construct stabilized IPW-ATT weights by setting treated (mobile) cases to weight 1 and assigning the entropy-balancing weights to controls, rescaled within each origin stratum so that the mean weight remains close to one. This aligns the counterfactual distribution of non-movers with the covariate profile of movers in each origin class (see [Supplementary Material](#anexo) for balance diagnostics). The resulting weights are then used in the outcome stage to estimate the causal effect of intergenerational mobility on preferences for the commodification of pensions.


### Effect heterogeneity

To test heterogeneity in mobility effects, I examine two moderators: meritocratic perceptions and time. Meritocracy is captured with two items [@young_rise_1958], one referring to effort (“In Chile, people are rewarded for their efforts”) and one to talent (“In Chile, people are rewarded for their intelligence and skills”), each answered on a five-point Likert scale (1 = “strongly disagree” to 5 = “strongly agree”). I average the two items into a single index and dichotomize it into low meritocracy (≤ 3) and high meritocracy (≥ 4). Time is measured by survey wave (2016, 2018, 2023) and entered as a categorical (dummy) variable. Both variables are used as moderators by interacting them with the mobility treatment to assess conditional average treatment effects—i.e., whether the effect of mobility varies across levels of meritocratic perceptions or across survey waves.

### Controls

All models include the same pre-treatment covariates $C$ used in the IPW construction, not to re-balance groups (entropy balancing already does so), but to (i) block backdoor paths from $C$ to the outcome $Y$ as implied by the DAG, and (ii) achieve double robustness: estimates remain consistent if either the weighting model or the outcome model is correctly specified. Concretely, I adjust for (a) father’s educational level, (b) co-residence with both parents at age 15, (c) nationality, (d) age, (e) sex, and (f) ethnicity, along with wave fixed effects to absorb secular trends.


## Analytical strategy

Because the dependent variable—the preference for pension commodification—is binary $(Y_{it}\in{0,1})$, I estimate weighted linear probability models (WLS) using stabilized inverse probability weights (IPW) obtained via entropy balancing. Although OLS is often questioned with binary outcomes, it consistently estimates the conditional mean $E(Y|X)$ under standard exogeneity $E[\varepsilon_i|X_i]=0$, and heteroskedasticity can be handled with robust or clustered standard errors [@wooldridge_introductory_2009, ch. 7.5]. WLS with IPW further improves efficiency and implements the ATT estimand by recreating the counterfactual distribution of non-movers [@gelman_regression_2020, pp. 270–272]. Linear models are preferred here because coefficients are directly interpretable as average differences in predicted probabilities, whereas non-linear models complicate both weighting and interpretation [@gelman_regression_2020, ch. 13].


Formally, the model is:
 
$$
Y_{it}=\alpha+\beta T_i+X_i'\gamma+\lambda_t+\varepsilon_{it}
$$ {#eq-final}


where $Y_{it}$ indicates whether individual $i$ in wave $t$ supports more market-based pension access; $\alpha$ is the baseline probability for the reference categories; $\beta T_i$ captures the intergenerational mobility contrast: $T_i=1$ when the observed destination is $D_i=k$ (mobile to $k$) and $T_i=0$ when $D_i=j$ (immobile), so that $\beta$ is the ATT within origin $O=j (\widehat\beta=\widehat{ATT}{j,k\mid j})$, i.e., the percentage-point change in the probability of preferring pension commodification from reaching $k$ rather than remaining in $j$. The term $X_i'\gamma$ includes the pre-treatment covariates $(C)$ used to construct the entropy-balancing weights; $\lambda_t$ are wave fixed effects; and $\varepsilon_{it}$ is idiosyncratic error. The analytic sample is restricted to individuals sharing the same origin $(O=j)$. Therefore, estimation uses pooled WLS with stabilized IPW–ATT from entropy balancing and CR2 standard errors clustered by individual to address heteroskedasticity and within-person dependence.

The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds if either the weighting model or the outcome model is correctly specified, while also improving efficiency [@wooldridge_introductory_2009]. These results are virtually identical to baseline models without covariates (see [Supplementary Material](#anexo) for complete models), with no substantive changes in the mobility coefficients. Heterogeneous effects by meritocratic perceptions and survey wave are examined through interaction models described in the previous section.

To evaluate the robustness of the findings, I implement two sets of sensitivity analyses. First, I conduct standard robustness checks by re-estimating the models under alternative codings of the outcome: (i) excluding neutral responses from the analysis, (ii) combining neutral responses with agreement (3–5 vs. 1–2), and (iii) using the original 5-point item in a linear specification. Second, I assess sensitivity to unmeasured confounding using the omitted-variable–bias framework of Cinelli and Hazlett [-@cinelli_making_2020], which quantifies how strong an unobserved confounder would need to be to explain away the estimated ATT. 


