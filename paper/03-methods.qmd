---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup2, include=FALSE}
 knitr::opts_chunk$set(echo=FALSE, warning = FALSE,message = FALSE, cache = TRUE,out.width = '85%',fig.pos= "H"
                       # , fig.align = 'center'
                       )
 # knitr::opts_knit$set(base.url = "../") #relative path for .html output file
 # knitr::opts_knit$set(root.dir = "../") #relative path for chunks within .rmd files
 options(scipen=999)
 options(kableExtra.auto_format = FALSE)
 options(knitr.kable.NA = '')
 options(knitr.graphics.error = FALSE)
 Sys.setlocale("LC_ALL", "ES_ES.UTF-8")
 
 table_format = if (knitr::is_html_output()) {
   #conditional instructions for kable
   "html" #if html set "html" in format
 } else if (knitr::is_latex_output()) {
   "latex"#if latex set "latex" in format
 }
```

```{r}
#| label: data1
#| echo: false
#| results: false
#| message: false
#| warning: false
library(here)
library(janitor)
library(dagitty)
library(ggdag)
library(tidyverse)

load(here("input/data/proc/data_v2.3.RData"))
```

# Method

Social mobility effects—understood as impacts on an outcome arising from movements between an origin state and a destination state (e.g., social class)—have long been a focus of sociological research [@eyles_social_2022; @langsaether_explaining_2022]. Yet, as Breen and Ermisch [-@breen_effects_2024, p.467] emphasize, most hypotheses are, at their core, individual-level counterfactual comparisons between the observed outcome under a mobility trajectory and the outcome the same person would have shown if they had remained in their origin class (or moved to an alternative destination). Standard specifications (e.g., SAM, DRM, and mobility-contrast models) struggle to retrieve these inherently counterfactual quantities due to identification constraints and their reliance on between-group contrasts constructed from additive terms and interactions, thereby yielding primarily associational evidence [@breen_effects_2024; @song_there_2025]. I therefore adopt Breen and Ermisch’s [-@breen_effects_2024] causal formulation, treating destination class as the treatment, conditioning on the class of origin, and estimating heterogeneous destination effects with observational data under explicit identification assumptions. To align design and target, I follow the MIDA template [@blair_research_2023]: set out the causal model and assumptions (M), define the inquiry and estimand (I), describe the data and variables (D), and detail the answer strategy (A) used to identify the causal effect of intergenerational social mobility on preferences for the commodification of pensions.

## A Causal Model for Mobility Effects

Breen and Ermisch [-@breen_effects_2024], building on a critical reassessment of the inferential limits of standard mobility models, propose a causal framework that reconceptualizes the “mobility effect” as the treatment effect of reaching a destination class, with impacts heterogeneous by class of origin. The core claim is that typical mobility hypotheses are fundamentally within-person counterfactual comparisons rather than between-person contrasts. Defining mobility as $M = D - O$ —a change from origin $(O)$ to destination $(D)$, rather than an additive or interactive combination—places the focus squarely on the Neyman–Rubin problem: for any individual, we observe the result in the social position they currently occupy, but not in the situation of other alternative destinations or immobility.

Exploiting the temporal ordering of origin, destination and outcome, Breen and Ermisch [-@breen_effects_2024] frame mobility as a treatment process that motivates the causal question: "how would the outcome among people from origin *j* who entered destination *k* have been different if those people had, counterfactually, entered destination *k’* instead?" (p.472). The corresponding estimand is the conditional causal effect of destination given origin. It is of particular interest when *k' = j*, i.e., immobility. This estimand compares movers’ observed outcomes with the hypothetical outcomes those same individuals would have exhibited had they remained in their origin class. This formulation provides a coherent potential-outcomes basis for studying how social mobility shape individual preferences and attitudes.

Following Breen and Ermisch [-@breen_effects_2024], the identification of causal mobility effects from observational data requires the following assumptions:

**Positivity**: For all $(j,c)$ in the support of $(O,C)$ and for each relevant destination $(k)$, the probability of receiving $D=k$ is strictly between 0 and 1; substantively, every $(O,C)$-type has non-zero chance of each comparison destination.

$$
 0<P(D=k\mid O=j, C=c)<1
$$ {#eq-posi}


**Stable Unit Treatment Value Assumption (SUTVA)**: each unit's potential outcomes $Y_i(D)$ does not depend on the mechanism used to assign treatments (destinations) and by the treatments assigned to other units (also called no interference), assuming a single, well-defined version of each treatment (consistency).

$$
Y_i(D_i) = Y_i\big(D_i, D_{-i}\big)\quad \forall, D_{-i}
$$ {#eq-sutva}

**Conditional Independence**: Also known as conditional unconfoundedness or exchangeability, this assumption emphasizes that, conditional on origin $O$ and pre-treatment covariates $C$ (e.g., parental education, ethnicity, cohort, early-life factors), assignment to $D$ is as good as random. This underlies IPW and regression adjustment, which seek exchangeability between mobile (treated) and immobile individuals (controls).

$$
Y(D)\ \perp\kern-5pt \perp D\ \mid\ (O,C)
$$ {#eq-indep}

In fact, establishing the causal relationship between social mobility and subjective outcomes, such as preferences, poses several challenges for causal inference. Below, I use directed acyclic graphs (DAGs) to illustrate some of these challenges and evaluate possible strategies for identifying the effects of social mobility. @fig-dag depicts the causal model guiding identification. In this model, a person's preference ($Y$) is directly caused by her class destination ($D$) and can also be affected by different attributes determined in childhood or earlier ($C$), such as family resources, household composition, and ascriptive status (pre-treatment confounders). Class origin ($O$) is determined by those origin-attributes ($C$) and, in turn, affects destination ($D$). In addition, denotes unobserved factors ($U$) can also influence origin-attributes ($C$). There is no direct arrow from $O$ to $Y$, reflecting the assumption that the effect of origin on the outcome operates entirely through background factors $(C)$ and destination $(D)$.  Accordingly, conditioning on $(O,C)$ could blocks the relevant back-door paths from $D$ to $Y$, specifically $D\leftarrow O\leftarrow C\rightarrow Y$ and, if present, $D \leftarrow O \rightarrow Y$, so $(O,C)$ is a minimal sufficient adjustment set.

```{r}
#| label: fig-dag
#| out-width: '85%'
#| fig-cap: "Causal graph of the effect of intergenerational social mobility on preferences for commodification. Y = preferences for pension commodification, my outcome of interest, D = an individual’s class of destination, O = an individual’s class of origin, C = different attributes determined in childhood or earlier that affects an individual’s class of origin and destination. Finally, U = unobserved factors influencing origin attributes."
#| fig-cap-location: bottom
#| echo: false
#| warning: false
#| message: false


dag_mjp <- dagify(
  Y ~ D + C,
  D ~ O + C,
  O ~ C,
  C ~ U,
  coords = time_ordered_coords(
    list(
      "U",
      c("C", "O"),
      "D",
      "Y"
    )
  ),
  exposure = "D",
  outcome = "Y",
  labels = c(
    Y = "Y",
    D = "D",
    O = "O",
    C = "C",
    U = "U"
  )
)

curvatures <- rep(0, 8)
curvatures[3] <- -.25

dag_mjp |>
  tidy_dagitty() |>
  ggplot(aes(x, y, xend = xend, yend = yend)) +
  geom_dag_point(shape = 21, fill = "black", size = 14, stroke = 0.8) +
  geom_dag_edges_arc(curvature = curvatures) +
  geom_dag_text(aes(label = label), color = "white", fontface = "bold", size = 4) +
  theme_dag()

```


Formally, the DAG encodes the following relations:
 
$$
U \rightarrow C,\quad C \rightarrow O,\quad C \rightarrow D,\quad C \rightarrow Y,\quad O \rightarrow D,\quad D \rightarrow Y
$$

This structure corresponds to a nonparametric structural causal model in which $(D)$ is the treatment variable, $(Y)$ the outcome, and $(O, C)$ the minimal sufficient adjustment set. Conditioning on these variables satisfies the back-door criterion for identifying the causal effect of mobility on preferences [@breen_effects_2024]. 

Why are the assumptions plausible here? Conditional independence is targeted by controlling for a plausible sufficient adjustment set $(O,C)$; entropy balancing/IPW enforces covariate balance within each origin stratum. Positivity is assessed via propensity scores and trimming of extreme weights, restricting to common support. SUTVA holds by treating the destination class as a single exposure measured before $(Y)$ and assuming no interference. Together, the DAG and assumptions define conditions for identifying the causal effect of intergenerational mobility on preferences for commodification.

## Inquiry and estimand

The causal inquiry guiding this study asks: How does intergenerational social mobility affect individuals’ preferences for the commodification of pensions in Chile? Following the potential outcomes framework proposed by Breen and Ermisch [-@breen_effects_2024, p.473], the estimand of interest is the average treatment effect on the treated (ATT), defined as the mean causal effect of moving from an origin class $(O=j)$ to a destination class $(D=k)$, compared with the counterfactual outcome that those same individuals would have exhibited had they instead reached an alternative destination $(k')$:

$$ 
ATT_{j,k,k′} =E[Y(D=k|O=j, D=k)]−E[Y(D=k′|O=j, D=k)]
$$ {#eq-breen}

In this study, I focus on the specific case where the counterfactual destination corresponds to class immobility $(k' = j)$, that is, how the outcome among people from origin *j* who entered destination *k* would have bee different if those people had, counterfactually, remained in origin *j* instead (inmobility). Accordingly, the estimand becomes:

$$ 
ATT_{j,k,j} =E[Y(D=k|O=j, D=k)]−E[Y(D=j|O=j, D=k)]
$$ {#eq-att}

which represents the average causal effect of attaining class *(k)*—for instance, moving upward or downward—relative to remaining in class *(j)*, among individuals who actually experienced such mobility. This estimand captures the within-origin counterfactual contrast at the heart of mobility effects: how a person’s preference for market-based pensions would differ if, counterfactually, they had stayed in their origin class rather than moved to their observed destination.


## Data and variables

### Data

This study draws on data from the Chilean Longitudinal Social Survey (ELSOC) of the Center for Social Conflict and Cohesion Studies (COES). This survey is a nationally representative panel study of the urban adult population in Chile, conducted annually between 2016 and 2023. Designed to examine individuals’ attitudes, emotions, and behaviors regarding social conflict and cohesion, ELSOC employs a probabilistic, stratified, clustered, and multistage sampling design covering both major urban centers and smaller cities. The sampling frame was proportionally stratified into six categories of urban population size (e.g., large and small cities), followed by a random selection of households within 1,067 city blocks. The target population includes men and women aged 18 to 75 who are habitual residents of private dwellings.

Because respondent occupation is not measured in every wave, I restrict the analysis to the 2016, 2018, and 2023 waves. Parental occupation was collected only in 2023 as open-text labels. I coded these texts to the ISCO-08 two-digit scheme using the National Institute of Statistics of Chile’s automated coding API and retained cases with high-confidence matches (>95%). Treating parental occupation as a time-invariant origin attribute, I carried these codes back to 2016 and 2018. After listwise deletion and restricting to key variables (respondent occupation and the outcome measure), the final analytic sample comprises *N* = 3,435 observations nested within *N* = 1,787 individuals (2016: 914; 2018: 1,377; 2023: 1,144). Consistent with the study design, estimation proceeds within trajectory-specific subsamples (e.g., low→low; low→middle), retaining movers and matched non-movers from the same origin class. Then, I apply weights to construct the corresponding counterfactual control sample for each trajectory. Following Breen and Ermisch [-@breen_effects_2024], I use the three waves in the estimations that follow, allowing for correlation between the observations for each individual in calculating the standard errors (i.e. clustering on the personal identifier).


### Outcome variable

The outcome variable measures preferences regarding the commodification of pensions, operationalized with a single item addressing how strongly individuals justify conditioning access to old-age pension benefits based on individual income. Respondents were asked: “Is it fair in Chile that people with higher incomes have better pensions than people with lower incomes?” and were asked to indicate their level of agreement on a five-point Likert scale ranging from 1 (“strongly disagree”) to 5 (“strongly agree”). For estimation and interpretability, I dichotomized the item so that values 4-5 indicate agreement with market-based access to old-age pensions (coded as 1), while values 1-3 indicate disagreement (coded as 0). This binary coding treats neutrality as substantially closer to non-support than to support and produces a clear contrast between respondents who support market-based differentiation in pensions and those who do not. I use this item for two main reasons: on the one hand, to be able to make comparisons with existing literature [@lindh_public_2015; @otero_power_2024; @castillo_perceptions_2025] and, on the other hand, because it captures two fundamental dimensions of market-based welfare distribution: the role of economic resources as a key determinant of outcomes and the framing of services as as tradable commodities that can be bought and sold based on ability to pay [@lindh_public_2015].

@tbl-summary1 shows the descriptive statistics of the variables used in the study.

```{r}
#| label: tbl-summary1
#| tbl-cap: "Descriptive statistics for all variables."
#| tbl-cap-location: top
#| results: asis
#| echo: false


t1 <- db %>% 
  select(just_pension_f, 
         estrato_orig, 
         estrato_ocupa, 
         educ_orig_f,
         hogar_bip_f, 
         nacionalidad_f, 
         sexo_f,
         m0_edad_f, 
         etnia_f, 
         merit_i,
         wave

)

t1 <- t1 %>% 
  mutate(
    just_pension_f = factor(just_pension_f, levels = c(0,1), labels = c("Disagree", "Agree")),
    hogar_bip_f  = factor(hogar_bip_f, levels = c(0,1), labels = c("No co-residence", "Co-residence")),
    #nacionalidad_f = if_else(nacionalidad_f == 0, 1, 0),
    nacionalidad_f  = factor(nacionalidad_f, levels = c(0,1), labels = c("Non-Chilean", "Chilean")),
    #sexo_f = if_else(sexo_f == 1, 0, 1),
    sexo_f  = factor(sexo_f, levels = c(0,1), labels = c("Male", "Female")),
    etnia_f = factor(etnia_f, levels = c(0,1), labels = c("Non-indigenous", "Indigenous"))
  )

t1$just_pension_f <- sjlabelled::set_label(t1$just_pension_f, "Preference for pension commodification")
t1$educ_orig_f <- sjlabelled::set_label(t1$educ_orig_f, "Parental education")
t1$hogar_bip_f <- sjlabelled::set_label(t1$hogar_bip_f, "Co-residence with both parents at age 15")
t1$nacionalidad_f <- sjlabelled::set_label(t1$nacionalidad_f, "Nacionality")
t1$sexo_f <- sjlabelled::set_label(t1$sexo_f, "Sex")
t1$m0_edad_f <- sjlabelled::set_label(t1$m0_edad_f, "Age (in years)")
t1$etnia_f <- sjlabelled::set_label(t1$etnia_f, "Indigenous ethnicity")
t1$merit_i <- sjlabelled::set_label(t1$merit_i, "Meritocracy perception")
t1$wave <- sjlabelled::set_label(t1$wave, "Wave")

df<-dfSummary(t1,
               plain.ascii = FALSE,
               style = "multiline",
               tmp.img.dir = "/tmp",
               graph.magnif = 0.75,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = F,    # missing
               graph.col = F, # plot
               valid.col = T, # n valido
               col.widths = c(30,10,10,10))

df$Variable <- NULL # delete variable column

print(df)

```

### Treatment

#### Intergenerational occupational mobility 

I treat intergenerational occupational mobility as an exposure indicating whether respondents occupy a different socioeconomic status than their fathers, closely following Breen and Ermisch’s [-@breen_effects_2024] causal framework. Class assignment proceeds in two steps. First, I derive status for both origin (father) and destination (respondent) from two-digit ISCO-08 occupations using the International Socio-Economic Index of Occupational Status (ISEI). ISEI is a hierarchical, unidimensional scale that locates occupations by incumbents’ average education and earnings and was explicitly designed to harmonize occupational stratification across other class schemes and socioeconomic status measures [@ganzeboom_internationally_1996], thereby supporting cross-study comparability [@barozet_measurement_2021a]. Second, I group both origin and destination ISEI scores into terciles (low, middle, high), yielding a three-category schema for origin and destination stratums (see @tbl-matrix). Substantively, I use ISEI because occupation-based measures capture structural locations that organize life chances and attitudes more directly than income alone: they bundle access to the means of production, qualification credentials, and the authority/power inherent in labor relations; central dimensions of stratification and inequality [@barone_rise_2022; @wrightUnderstandingClass2015]. In short, using ISEI aligns the measurement of origin and destination on a common vertical status continuum that is theoretically meaningful for social mobility research and empirically feasible given the available information of ELSOC’s data.


```{r}
#| label: tbl-matrix
#| tbl-cap: "Occupational mobility by occupational groups."
#| tbl-cap-location: top
#| results: asis
#| echo: false

db %>%
  tabyl(estrato_orig, estrato_ocupa) %>%
  adorn_totals(where = c("row", "col")) %>%     # agrega totales
  adorn_percentages("row") %>%                  # porcentajes por fila
  adorn_pct_formatting(digits = 1) %>%          # formato %
  adorn_ns() %>% 
  as_tibble() %>% 
  mutate(Offspring = NA) %>% 
  select(estrato_orig, Offspring, everything()) %>% 
  kableExtra::kable(format = table_format, 
                    booktabs= T,
                    align = 'c', 
                    col.names = c("Father↓", "Offspring→", "Low", "Middle", "High", "Total"),
                    caption = NULL) %>%
  kableExtra::kable_styling(latex_options = "hold_position", 
                            bootstrap_options = "striped",
                            full_width = F) 


```


#### Pre-treatment control variables for selection into treatment

Within each origin stratum $O=j$, I estimate average treatment effects on the treated (ATT) by comparing movers to otherwise similar non-movers from the same origin. To adjust for selection into mobility, I reweight only the control group (immobile) using entropy balancing so that the distribution of pre-treatment origin covariates $C$ matches that of the treated on selected moments.

The selection of the adjustment set $C$ follows two principles. First, it mirrors the logic in Breen and Ermisch [-@breen_effects_2024]—who condition on attributes determined in childhood or earlier (e.g., parental resources, household structure, ascriptive traits)—and, second, it is constrained to origin-side characteristics available in ELSOC. Guided by theory and Chilean evidence on relative mobility determinants [mainly @brunori_inequality_2025; @celhay_intergenerational_2010; @espinoza_movilidad_2014;@torche_unequal_2005], I include six covariates covering family resources, household composition, and ascriptive status: (a) parental education (highest of father/mother), 10 categories coded ordinally from no schooling to postgraduate studies; (b) co-residence with both parents at age 15 (0 = no, 1 = yes); (c) nationality (0 = non-Chilean, 1 = Chilean); (d) age in years; (e) sex (0 = male, 1 = female); and (f) indigenous ethnicity (0 = no, 1 = yes). These variables are fixed before the destination class, plausibly affect selection into mobility, and constitute the maximal origin set in ELSOC, thereby making the conditional independence assumption more credible within each $O=j$. 

After balancing, I construct stabilized IPW, setting treated weights to 1 and assigning derived weights to controls, thus aligning the counterfactual distribution of non-movers with the covariate profile of movers in each origin stratum (see [Supplementary Material](#anexo) for the evaluation of balance). These weights are then used in the outcome stage to estimate the causal effect of mobility on preferences for the commodification of pensions.

### Effect heterogeneity

To test heterogeneity in mobility effects, I examine two moderators: meritocratic perceptions and time. Meritocracy is captured with two items [@young_rise_1958], one referring to effort (“In Chile, people are rewarded for their efforts”) and one to talent (“In Chile, people are rewarded for their intelligence and skills”), each answered on a five-point Likert scale (1 = “strongly disagree” to 5 = “strongly agree”). I average the two items into a single index and dichotomize it into low meritocracy (≤ 3) and high meritocracy (≥ 4). Time is measured by survey wave (2016, 2018, 2023) and entered as a categorical (dummy) variable. Both variables are used as moderators by interacting them with the mobility treatment to assess conditional average treatment effects—i.e., whether the effect of mobility varies across levels of meritocratic beliefs or across survey waves.

### Controls

All models include the same pre-treatment covariates $C$ used in the IPW construction, not to re-balance groups (entropy balancing already does so), but to (i) block backdoor paths from $C$ to the outcome $Y$ as implied by the DAG, and (ii) achieve double robustness: estimates remain consistent if either the weighting model or the outcome model is correctly specified. Concretely, I adjust for (a) father’s educational level, (b) co-residence with both parents at age 15, (c) nationality, (d) age, (e) sex, and (f) ethnicity, along with wave fixed effects to absorb secular trends.


## Analytical strategy

Because the dependent variable—the preference for pension commodification—is binary $(Y_{it}\in{0,1})$, I estimate weighted linear probability models (WLS) using stabilized inverse probability weights (IPW) obtained via entropy balancing. Although OLS estimator is often questioned with binary outcomes, it’s unbiased. It consistently estimates the conditional expectation $E(Y|X)$ under standard exogeneity $E[\varepsilon_i|X_i]=0$, with heteroskedasticity addressed by robust or clustered errors [@wooldridge_introductory_2009, ch. 7.5]. WLS further improves efficiency under heteroskedasticity or unequal sampling probabilities [@wooldridge_introductory_2009, ch. 8.4]. Following Gelman, Hill, and Vehtari [-@gelman_regression_2020, pp. 270–272], IPW-weighted regression transparently targets the ATT by recreating the counterfactual distribution. Linear models are preferred here because coefficients are average probability differences; nonlinear models (logit/probit) complicate weighting and interpretation [@gelman_regression_2020, ch. 13].

Formally, the model is:
 
$$
Y_{it}=\alpha+\beta T_i+X_i'\gamma+\lambda_t+\varepsilon_{it}
$$ {#eq-final}

where $Y_{it}$ indicates whether individual $i$ in wave $t$ supports more market-based pension access; $\alpha$ is the baseline probability for the reference categories; $\beta T_i$ captures the intergenerational mobility contrast: $T_i=1$ when the observed destination is $D_i=k$ (mobile to $k$) and $T_i=0$ when $D_i=j$ (immobile), so that $\beta$ is the ATT within origin $O=j (\widehat\beta=\widehat{ATT}{j,k\mid j})$, i.e., the percentage-point change in the probability of preferring pension commodification from reaching $k$ rather than remaining in $j$. The term $X_i'\gamma$ includes the pre-treatment covariates $(C)$ used to construct the entropy-balancing weights; $\lambda_t$ are wave fixed effects; and $\varepsilon_{it}$ is idiosyncratic error. The analytic sample is restricted to individuals sharing the same origin $(O=j)$. Estimation uses pooled WLS with stabilized IPW–ATT from entropy balancing and CR2 standard errors clustered by individual to address heteroskedasticity and within-person dependence.

The specification is doubly robust: entropy-balancing weights are combined with covariate adjustment so consistency holds if either the weighting model or the outcome model is correctly specified, while also improving efficiency [@wooldridge_introductory_2009]. These results are virtually identical to baseline models without covariates (see [Supplementary Material](#anexo) for complete models), with no substantive changes in the mobility coefficients. In addition, I assess causal heterogeneity by interacting the mobility treatment with (i) meritocratic perceptions and (ii) survey wave, reporting simple slopes (origin-specific ATTs) by moderator levels. To evaluate sensitivity to unmeasured confounding, I compute E-values for point estimates and confidence limits [@ding_sensitivity_2016]. To address multiplicity across the six mobility trajectories, I also report Holm-adjusted p-values alongside 95% confidence intervals.

All the analyses were conducted using R software and the _lm_robust_ package.

